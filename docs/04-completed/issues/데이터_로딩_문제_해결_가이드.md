# ì›¹ì•± ë°ì´í„° ë¡œë”© ë¬¸ì œ í•´ê²° ê°€ì´ë“œ

## ğŸš¨ í˜„ì¬ ë¬¸ì œ

http://localhost:5173/ ì—ì„œ Supabase ê¸°ë¡ì´ ì¡°íšŒë˜ì§€ ì•ŠëŠ” ì´ìœ :
1. âŒ habit_tracker í…Œì´ë¸”ì˜ 24ê°œ ë ˆì½”ë“œ ëª¨ë‘ user_idê°€ NULL
2. âŒ Migration 013ì´ ë°°í¬ë˜ì§€ ì•ŠìŒ (idempotency_log í…Œì´ë¸” ì—†ìŒ)

## âœ… í•´ê²° ë°©ë²• (5ë‹¨ê³„ - ì•½ 10ë¶„ ì†Œìš”)

### 1ë‹¨ê³„: Migration 013 ë°°í¬

**ë¬´ì—‡ì„**: idempotency_log í…Œì´ë¸” ìƒì„± (Edge Functionìš©)

**ì‹¤í–‰ ë°©ë²•**:
1. [Supabase SQL Editor ì—´ê¸°](https://supabase.com/dashboard/project/gqvyzqodyspvwlwfjmfg/editor)
2. ë¡œì»¬ íŒŒì¼ ì—´ê¸°: `supabase/migrations/013_create_dual_write_triggers.sql`
3. íŒŒì¼ ë‚´ìš© ì „ì²´ ë³µì‚¬ (ì•½ 400ì¤„)
4. SQL Editorì— ë¶™ì—¬ë„£ê¸°
5. "Run" ë²„íŠ¼ í´ë¦­
6. âœ… í™•ì¸: "Success. No rows returned" ë©”ì‹œì§€

---

### 2ë‹¨ê³„: User ID í™•ì¸

**ë°©ë²• A: ì›¹ì•±ì—ì„œ í™•ì¸ (ì¶”ì²œ)**
```javascript
// 1. http://localhost:5173/ ì ‘ì†
// 2. ë¡œê·¸ì¸
// 3. ë¸Œë¼ìš°ì € ì½˜ì†” ì—´ê¸° (F12)
// 4. ì•„ë˜ ì½”ë“œ ë¶™ì—¬ë„£ê¸°:
const { data: { user } } = await window.supabase.auth.getUser();
console.log('User ID:', user.id);
// 5. ë‚˜ì˜¨ User ID ë³µì‚¬
```

**ë°©ë²• B: Supabase ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸**
1. https://supabase.com/dashboard/project/gqvyzqodyspvwlwfjmfg/auth/users ì ‘ì†
2. ì‚¬ìš©ì ëª©ë¡ì—ì„œ ë³¸ì¸ ì°¾ê¸°
3. í´ë¦­í•´ì„œ UUID í™•ì¸
4. User ID ë³µì‚¬

**ë°©ë²• C: ìƒˆ ì‚¬ìš©ì ìƒì„±**
```
1. http://localhost:5173/ ì ‘ì†
2. "íšŒì›ê°€ì…" í´ë¦­
3. ì´ë©”ì¼: test@example.com
4. ë¹„ë°€ë²ˆí˜¸: testpassword123
5. ê°€ì… í›„ ë°©ë²• Aë¡œ User ID í™•ì¸
```

**ë„ì›€ ìŠ¤í¬ë¦½íŠ¸** (ì„ íƒì‚¬í•­):
```bash
node scripts/get-user-id.js
```

---

### 3ë‹¨ê³„: ê¸°ì¡´ ë ˆì½”ë“œì— user_id ì¶”ê°€

**ì‹¤í–‰**: 24ê°œ ë ˆì½”ë“œì— ë‹¹ì‹ ì˜ user_id ì¶”ê°€

```bash
# YOUR_USER_IDë¥¼ 2ë‹¨ê³„ì—ì„œ ë³µì‚¬í•œ UUIDë¡œ êµì²´
node scripts/add-user-id-to-existing-data.js YOUR_USER_ID
```

**ì˜ˆì‹œ**:
```bash
node scripts/add-user-id-to-existing-data.js fc24adf2-a7af-4fbf-abe0-c332bb48b02b
```

**ì˜ˆìƒ ì¶œë ¥**:
```
ğŸ”§ Adding user_id to existing habit_tracker records

User ID: fc24adf2-a7af-4fbf-abe0-c332bb48b02b

Found 24 records without user_id

Sample records to update:
  1. ì•„ì´ 1 - 2024ë…„ 7ì›” 21ì¼ ~ 2024ë…„ 7ì›” 27ì¼
  2. ì•„ì´ 2 - 2024ë…„ 7ì›” 21ì¼ ~ 2024ë…„ 7ì›” 27ì¼
  ...

â³ Updating records...

âœ… Successfully updated 24 records

ğŸ“Š Verification:
  Records without user_id: 0
  Records updated: 24

âœ… All records now have user_id!
```

---

### 4ë‹¨ê³„: ìˆ˜ì • í™•ì¸

**ì‹¤í–‰**: ëª¨ë“  ë ˆì½”ë“œì— user_idê°€ ìˆëŠ”ì§€ í™•ì¸

```bash
node scripts/check-database-status.js
```

**í™•ì¸ ì‚¬í•­**:
```
ğŸ“Š Checking OLD SCHEMA (habit_tracker)...

  Total records: 24
  Sample records: 5

  Record 1:
    ID: ...
    Child: ì•„ì´ 1
    Week: 2024ë…„ 7ì›” 21ì¼ ~ 2024ë…„ 7ì›” 27ì¼
    Has user_id: YES (fc24adf2-...)  â† ì´ì œ YESë¡œ ë‚˜ì™€ì•¼ í•¨
    Habits: 12

  Record 2:
    Has user_id: YES (fc24adf2-...)  â† ëª¨ë“  ë ˆì½”ë“œê°€ YES
```

âœ… **ì„±ê³µ**: ëª¨ë“  ë ˆì½”ë“œê°€ "Has user_id: YES"
âŒ **ì‹¤íŒ¨**: "Has user_id: NO"ê°€ ë‚¨ì•„ìˆìŒ â†’ 3ë‹¨ê³„ ë‹¤ì‹œ ì‹¤í–‰

---

### 5ë‹¨ê³„: ì›¹ì•± í…ŒìŠ¤íŠ¸

**ì‹¤í–‰**: ì›¹ì•±ì—ì„œ ë°ì´í„° ë¡œë”© í™•ì¸

1. **ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨**: http://localhost:5173/
2. **ë¡œê·¸ì¸**: 2ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•œ ê²ƒê³¼ ê°™ì€ ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸
   - ì´ë©”ì¼: (2ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•œ ì´ë©”ì¼)
   - ë¹„ë°€ë²ˆí˜¸: (2ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•œ ë¹„ë°€ë²ˆí˜¸)
3. **ë°ì´í„° í™•ì¸**: ì´ì œ ë³´ì—¬ì•¼ í•˜ëŠ” ê²ƒë“¤:
   - ì•„ì´ ì„ íƒ ë©”ë‰´ì— ì•„ì´ ëª©ë¡ í‘œì‹œë¨
   - ì„ íƒí•œ ì•„ì´ì˜ ìŠµê´€ ì¶”ì  ë°ì´í„° í‘œì‹œë¨
   - ì£¼ì°¨ ì„ íƒì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ì£¼ì°¨ ëª©ë¡ í‘œì‹œë¨

âœ… **ì„±ê³µ**: ë°ì´í„°ê°€ ì •ìƒì ìœ¼ë¡œ ë¡œë”©ë˜ê³  í‘œì‹œë¨
âŒ **ì‹¤íŒ¨**: ì—¬ì „íˆ ë°ì´í„° ì—†ìŒ â†’ ì•„ë˜ ë¬¸ì œí•´ê²° ì°¸ê³ 

---

## ğŸ”§ ë¬¸ì œí•´ê²°

### ë¬¸ì œ: ìˆ˜ì • í›„ì—ë„ "ë ˆì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"

**ê°€ëŠ¥í•œ ì›ì¸**:
1. 2ë‹¨ê³„ì™€ ë‹¤ë¥¸ ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸í•¨
2. ë¸Œë¼ìš°ì € ìºì‹œê°€ ë‚¨ì•„ìˆìŒ
3. ì½”ë“œì—ì„œ user_id ì²´í¬ê°€ ì—¬ì „íˆ ì£¼ì„ì²˜ë¦¬ë¨

**í•´ê²° ë°©ë²•**:

**ì²´í¬ 1: ê°™ì€ ì‚¬ìš©ìì¸ì§€ í™•ì¸**
```javascript
// ë¸Œë¼ìš°ì € ì½˜ì†” (F12)ì—ì„œ:
const { data: { user } } = await window.supabase.auth.getUser();
console.log('Current user:', user.id);
// 3ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•œ user_idì™€ ì¼ì¹˜í•´ì•¼ í•¨
```

**ì²´í¬ 2: ê°•ë ¥ ìƒˆë¡œê³ ì¹¨**
- Chrome/Edge: Ctrl+Shift+R (Windows) ë˜ëŠ” Cmd+Shift+R (Mac)
- Firefox: Ctrl+F5 (Windows) ë˜ëŠ” Cmd+Shift+R (Mac)
- Safari: Cmd+Option+R (Mac)

**ì²´í¬ 3: ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ user_id í™•ì¸**
```bash
node scripts/check-database-status.js
```
ëª¨ë“  ë ˆì½”ë“œê°€ "Has user_id: YES (YOUR_ID)" í‘œì‹œë˜ëŠ”ì§€ í™•ì¸

---

### ë¬¸ì œ: Migration 013 ë°°í¬ ì‹¤íŒ¨

**ì—ëŸ¬**: "relation 'idempotency_log' already exists"
**í•´ê²°**: í…Œì´ë¸”ì´ ì´ë¯¸ ìƒì„±ë˜ì–´ ìˆìŒ. ë¬´ì‹œí•˜ê³  2ë‹¨ê³„ë¡œ ì§„í–‰.

**ì—ëŸ¬**: "permission denied"
**í•´ê²°**: 
1. Supabaseì— owner/admin ê¶Œí•œìœ¼ë¡œ ë¡œê·¸ì¸í–ˆëŠ”ì§€ í™•ì¸
2. í”„ë¡œì íŠ¸ URLì´ ë§ëŠ”ì§€ í™•ì¸: gqvyzqodyspvwlwfjmfg

**ì—ëŸ¬**: "syntax error at or near..."
**í•´ê²°**:
1. íŒŒì¼ ì „ì²´ë¥¼ ë³µì‚¬í–ˆëŠ”ì§€ í™•ì¸ (ì£¼ì„ í¬í•¨)
2. ì‹œì‘/ëì— ì—¬ë¶„ì˜ ë¬¸ìê°€ ì—†ëŠ”ì§€ í™•ì¸
3. ë‹¤ì‹œ ë³µì‚¬í•´ì„œ ì¬ì‹œë„

---

### ë¬¸ì œ: ìŠ¤í¬ë¦½íŠ¸ ì—ëŸ¬ "Cannot read .env file"

**í•´ê²°**:
```bash
# 1. .env íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
ls -la .env

# 2. .envì— í•„ìš”í•œ ë³€ìˆ˜ê°€ ìˆëŠ”ì§€ í™•ì¸
cat .env | grep VITE_SUPABASE

# ë‹¤ìŒê³¼ ê°™ì´ ë‚˜ì™€ì•¼ í•¨:
# VITE_SUPABASE_URL=https://...
# VITE_SUPABASE_ANON_KEY=eyJ...
```

ì—†ìœ¼ë©´ .env íŒŒì¼ ìƒì„±:
```bash
cp .env.example .env
# ê·¸ ë‹¤ìŒ .envë¥¼ í¸ì§‘í•´ì„œ Supabase ìê²©ì¦ëª… ì…ë ¥
```

---

### ë¬¸ì œ: "Records updated: 0"

**ì›ì¸**: ëª¨ë“  ë ˆì½”ë“œì— ì´ë¯¸ user_idê°€ ìˆìŒ

**í™•ì¸**:
```bash
node scripts/check-database-status.js
```

ëª¨ë‘ "Has user_id: YES"ë¡œ ë‚˜ì˜¤ë©´ ë°ì´í„°ëŠ” ì´ë¯¸ ìˆ˜ì •ë¨.

**ë‹¤ìŒ**: ë°ì´í„°ë¥¼ ì†Œìœ í•œ ì‚¬ìš©ìë¡œ ì›¹ì•±ì— ë¡œê·¸ì¸ ì‹œë„.

---

## ğŸ“Š í™•ì¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

ìˆ˜ì • ì™„ë£Œë¡œ ê°„ì£¼í•˜ê¸° ì „ì— í™•ì¸:

- [ ] Migration 013 ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë¨
- [ ] 2ë‹¨ê³„ì—ì„œ User ID í™•ë³´í•¨
- [ ] ìŠ¤í¬ë¦½íŠ¸ë¡œ 24ê°œ ë ˆì½”ë“œ ì—…ë°ì´íŠ¸í•¨ (ë˜ëŠ” ì´ë¯¸ ì—…ë°ì´íŠ¸ë˜ì–´ 0)
- [ ] check-database-status.jsì—ì„œ ëª¨ë‘ "Has user_id: YES" í‘œì‹œ
- [ ] ì›¹ì•±ì—ì„œ ìŠµê´€ ì¶”ì  ë°ì´í„° ë¡œë”©ë˜ê³  í‘œì‹œë¨
- [ ] ë‹¤ë¥¸ ì•„ì´ì™€ ì£¼ì°¨ ì„ íƒ ê°€ëŠ¥í•¨

---

## ğŸ¯ ìˆ˜ì • ì™„ë£Œ í›„

### ìˆ˜ì •ëœ ê²ƒë“¤:
âœ… 24ê°œì˜ habit_tracker ë ˆì½”ë“œì— ëª¨ë‘ user_id ì¶”ê°€ë¨
âœ… Edge Functionìš© idempotency_log í…Œì´ë¸” ìƒì„±ë¨
âœ… ì›¹ì•±ì´ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê³  í‘œì‹œ ê°€ëŠ¥
âœ… ì¸ì¦ íë¦„ì´ ì •ìƒ ì‘ë™í•¨

### ë‹¤ìŒ ë‹¨ê³„: Edge Function ë°°í¬

ì›¹ì•±ì—ì„œ ë°ì´í„°ê°€ ì •ìƒì ìœ¼ë¡œ ë¡œë”©ë˜ë©´, ë‹¤ìŒìœ¼ë¡œ ì§„í–‰:

**Phase 1 Day 2: Edge Function ë°°í¬**

```bash
# 1. dual-write Edge Function ë°°í¬
npx supabase functions deploy dual-write-habit

# 2. Edge Function í…ŒìŠ¤íŠ¸
node scripts/test-edge-function.js

# 3. dual-write ì‘ë™ í™•ì¸
# (í…ŒìŠ¤íŠ¸ê°€ ë‘ ìŠ¤í‚¤ë§ˆì—ì„œ ë ˆì½”ë“œ ìƒì„±, ì—…ë°ì´íŠ¸, ì‚­ì œ)
```

ìì„¸í•œ ë‚´ìš©: `supabase/functions/DEPLOYMENT.md` ì°¸ê³ 

---

## ğŸ“ ìš”ì•½

**ë¬¸ì œ**:
- ê¸°ì¡´ habit_tracker ë ˆì½”ë“œì— user_idê°€ ì—†ì–´ì„œ ë°ì´í„° ì¡°íšŒ ë¶ˆê°€
- Edge Functionì— í•„ìš”í•œ idempotency_log í…Œì´ë¸” ëˆ„ë½

**í•´ê²° ë°©ë²•**:
1. Migration 013 ë°°í¬ (Supabase Dashboardì—ì„œ SQL ì‹¤í–‰)
2. ì›¹ì•±ì´ë‚˜ ëŒ€ì‹œë³´ë“œì—ì„œ ì‚¬ìš©ì UUID í™•ë³´
3. ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰í•´ì„œ 24ê°œ ë ˆì½”ë“œì— user_id ì¶”ê°€
4. ëª¨ë“  ë ˆì½”ë“œê°€ ì‚¬ìš©ìì™€ ì—°ê²°ë˜ì—ˆëŠ”ì§€ í™•ì¸
5. ë¡œê·¸ì¸ í›„ ì›¹ì•±ì—ì„œ ë°ì´í„° ë¡œë”© í™•ì¸

**ì™œ ì¤‘ìš”í•œê°€**:
- ì•±ì´ ì‚¬ìš©ì ì¸ì¦ê³¼ í•¨ê»˜ Row Level Security (RLS) ì‚¬ìš©
- ì¿¼ë¦¬ê°€ user_idë¡œ í•„í„°ë§í•´ì„œ ì‚¬ìš©ì ë°ì´í„°ë§Œ í‘œì‹œ
- user_id ì—†ìœ¼ë©´ ì¸ì¦ëœ ì¿¼ë¦¬ì—ì„œ ë ˆì½”ë“œê°€ ë³´ì´ì§€ ì•ŠìŒ
- Phase 1 dual-write ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸í•˜ê¸° ì „ì— í•„ìˆ˜

---

**ìƒíƒœ**: ë°°í¬ ì¤€ë¹„ ì™„ë£Œ
**ë‹¤ìŒ**: ìœ„ì˜ 1ë‹¨ê³„ë¶€í„° ì‹œì‘
**ì†Œìš” ì‹œê°„**: ì „ì²´ 5ë‹¨ê³„ ì•½ 10ë¶„
**ì‘ì„±ì¼**: 2025-10-12
