# 웹앱 데이터 로딩 문제 해결 가이드

## 🚨 현재 문제

http://localhost:5173/ 에서 Supabase 기록이 조회되지 않는 이유:
1. ❌ habit_tracker 테이블의 24개 레코드 모두 user_id가 NULL
2. ❌ Migration 013이 배포되지 않음 (idempotency_log 테이블 없음)

## ✅ 해결 방법 (5단계 - 약 10분 소요)

### 1단계: Migration 013 배포

**무엇을**: idempotency_log 테이블 생성 (Edge Function용)

**실행 방법**:
1. [Supabase SQL Editor 열기](https://supabase.com/dashboard/project/gqvyzqodyspvwlwfjmfg/editor)
2. 로컬 파일 열기: `supabase/migrations/013_create_dual_write_triggers.sql`
3. 파일 내용 전체 복사 (약 400줄)
4. SQL Editor에 붙여넣기
5. "Run" 버튼 클릭
6. ✅ 확인: "Success. No rows returned" 메시지

---

### 2단계: User ID 확인

**방법 A: 웹앱에서 확인 (추천)**
```javascript
// 1. http://localhost:5173/ 접속
// 2. 로그인
// 3. 브라우저 콘솔 열기 (F12)
// 4. 아래 코드 붙여넣기:
const { data: { user } } = await window.supabase.auth.getUser();
console.log('User ID:', user.id);
// 5. 나온 User ID 복사
```

**방법 B: Supabase 대시보드에서 확인**
1. https://supabase.com/dashboard/project/gqvyzqodyspvwlwfjmfg/auth/users 접속
2. 사용자 목록에서 본인 찾기
3. 클릭해서 UUID 확인
4. User ID 복사

**방법 C: 새 사용자 생성**
```
1. http://localhost:5173/ 접속
2. "회원가입" 클릭
3. 이메일: test@example.com
4. 비밀번호: testpassword123
5. 가입 후 방법 A로 User ID 확인
```

**도움 스크립트** (선택사항):
```bash
node scripts/get-user-id.js
```

---

### 3단계: 기존 레코드에 user_id 추가

**실행**: 24개 레코드에 당신의 user_id 추가

```bash
# YOUR_USER_ID를 2단계에서 복사한 UUID로 교체
node scripts/add-user-id-to-existing-data.js YOUR_USER_ID
```

**예시**:
```bash
node scripts/add-user-id-to-existing-data.js fc24adf2-a7af-4fbf-abe0-c332bb48b02b
```

**예상 출력**:
```
🔧 Adding user_id to existing habit_tracker records

User ID: fc24adf2-a7af-4fbf-abe0-c332bb48b02b

Found 24 records without user_id

Sample records to update:
  1. 아이 1 - 2024년 7월 21일 ~ 2024년 7월 27일
  2. 아이 2 - 2024년 7월 21일 ~ 2024년 7월 27일
  ...

⏳ Updating records...

✅ Successfully updated 24 records

📊 Verification:
  Records without user_id: 0
  Records updated: 24

✅ All records now have user_id!
```

---

### 4단계: 수정 확인

**실행**: 모든 레코드에 user_id가 있는지 확인

```bash
node scripts/check-database-status.js
```

**확인 사항**:
```
📊 Checking OLD SCHEMA (habit_tracker)...

  Total records: 24
  Sample records: 5

  Record 1:
    ID: ...
    Child: 아이 1
    Week: 2024년 7월 21일 ~ 2024년 7월 27일
    Has user_id: YES (fc24adf2-...)  ← 이제 YES로 나와야 함
    Habits: 12

  Record 2:
    Has user_id: YES (fc24adf2-...)  ← 모든 레코드가 YES
```

✅ **성공**: 모든 레코드가 "Has user_id: YES"
❌ **실패**: "Has user_id: NO"가 남아있음 → 3단계 다시 실행

---

### 5단계: 웹앱 테스트

**실행**: 웹앱에서 데이터 로딩 확인

1. **브라우저 새로고침**: http://localhost:5173/
2. **로그인**: 2단계에서 사용한 것과 같은 사용자로 로그인
   - 이메일: (2단계에서 사용한 이메일)
   - 비밀번호: (2단계에서 사용한 비밀번호)
3. **데이터 확인**: 이제 보여야 하는 것들:
   - 아이 선택 메뉴에 아이 목록 표시됨
   - 선택한 아이의 습관 추적 데이터 표시됨
   - 주차 선택에서 사용 가능한 주차 목록 표시됨

✅ **성공**: 데이터가 정상적으로 로딩되고 표시됨
❌ **실패**: 여전히 데이터 없음 → 아래 문제해결 참고

---

## 🔧 문제해결

### 문제: 수정 후에도 "레코드를 찾을 수 없음"

**가능한 원인**:
1. 2단계와 다른 사용자로 로그인함
2. 브라우저 캐시가 남아있음
3. 코드에서 user_id 체크가 여전히 주석처리됨

**해결 방법**:

**체크 1: 같은 사용자인지 확인**
```javascript
// 브라우저 콘솔 (F12)에서:
const { data: { user } } = await window.supabase.auth.getUser();
console.log('Current user:', user.id);
// 3단계에서 사용한 user_id와 일치해야 함
```

**체크 2: 강력 새로고침**
- Chrome/Edge: Ctrl+Shift+R (Windows) 또는 Cmd+Shift+R (Mac)
- Firefox: Ctrl+F5 (Windows) 또는 Cmd+Shift+R (Mac)
- Safari: Cmd+Option+R (Mac)

**체크 3: 데이터베이스에서 user_id 확인**
```bash
node scripts/check-database-status.js
```
모든 레코드가 "Has user_id: YES (YOUR_ID)" 표시되는지 확인

---

### 문제: Migration 013 배포 실패

**에러**: "relation 'idempotency_log' already exists"
**해결**: 테이블이 이미 생성되어 있음. 무시하고 2단계로 진행.

**에러**: "permission denied"
**해결**: 
1. Supabase에 owner/admin 권한으로 로그인했는지 확인
2. 프로젝트 URL이 맞는지 확인: gqvyzqodyspvwlwfjmfg

**에러**: "syntax error at or near..."
**해결**:
1. 파일 전체를 복사했는지 확인 (주석 포함)
2. 시작/끝에 여분의 문자가 없는지 확인
3. 다시 복사해서 재시도

---

### 문제: 스크립트 에러 "Cannot read .env file"

**해결**:
```bash
# 1. .env 파일이 있는지 확인
ls -la .env

# 2. .env에 필요한 변수가 있는지 확인
cat .env | grep VITE_SUPABASE

# 다음과 같이 나와야 함:
# VITE_SUPABASE_URL=https://...
# VITE_SUPABASE_ANON_KEY=eyJ...
```

없으면 .env 파일 생성:
```bash
cp .env.example .env
# 그 다음 .env를 편집해서 Supabase 자격증명 입력
```

---

### 문제: "Records updated: 0"

**원인**: 모든 레코드에 이미 user_id가 있음

**확인**:
```bash
node scripts/check-database-status.js
```

모두 "Has user_id: YES"로 나오면 데이터는 이미 수정됨.

**다음**: 데이터를 소유한 사용자로 웹앱에 로그인 시도.

---

## 📊 확인 체크리스트

수정 완료로 간주하기 전에 확인:

- [ ] Migration 013 성공적으로 배포됨
- [ ] 2단계에서 User ID 확보함
- [ ] 스크립트로 24개 레코드 업데이트함 (또는 이미 업데이트되어 0)
- [ ] check-database-status.js에서 모두 "Has user_id: YES" 표시
- [ ] 웹앱에서 습관 추적 데이터 로딩되고 표시됨
- [ ] 다른 아이와 주차 선택 가능함

---

## 🎯 수정 완료 후

### 수정된 것들:
✅ 24개의 habit_tracker 레코드에 모두 user_id 추가됨
✅ Edge Function용 idempotency_log 테이블 생성됨
✅ 웹앱이 사용자 데이터를 조회하고 표시 가능
✅ 인증 흐름이 정상 작동함

### 다음 단계: Edge Function 배포

웹앱에서 데이터가 정상적으로 로딩되면, 다음으로 진행:

**Phase 1 Day 2: Edge Function 배포**

```bash
# 1. dual-write Edge Function 배포
npx supabase functions deploy dual-write-habit

# 2. Edge Function 테스트
node scripts/test-edge-function.js

# 3. dual-write 작동 확인
# (테스트가 두 스키마에서 레코드 생성, 업데이트, 삭제)
```

자세한 내용: `supabase/functions/DEPLOYMENT.md` 참고

---

## 📝 요약

**문제**:
- 기존 habit_tracker 레코드에 user_id가 없어서 데이터 조회 불가
- Edge Function에 필요한 idempotency_log 테이블 누락

**해결 방법**:
1. Migration 013 배포 (Supabase Dashboard에서 SQL 실행)
2. 웹앱이나 대시보드에서 사용자 UUID 확보
3. 업데이트 스크립트 실행해서 24개 레코드에 user_id 추가
4. 모든 레코드가 사용자와 연결되었는지 확인
5. 로그인 후 웹앱에서 데이터 로딩 확인

**왜 중요한가**:
- 앱이 사용자 인증과 함께 Row Level Security (RLS) 사용
- 쿼리가 user_id로 필터링해서 사용자 데이터만 표시
- user_id 없으면 인증된 쿼리에서 레코드가 보이지 않음
- Phase 1 dual-write 기능 테스트하기 전에 필수

---

**상태**: 배포 준비 완료
**다음**: 위의 1단계부터 시작
**소요 시간**: 전체 5단계 약 10분
**작성일**: 2025-10-12
