# Children Table Architecture Diagram

## Table Structure

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                      CHILDREN TABLE                         â”ƒ
â”ƒ                   (Phase 0 Shadow Schema)                   â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Column Name     â”‚ Type         â”‚ Nullable â”‚ Default         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id              â”‚ UUID         â”‚ NOT NULL â”‚ gen_random_uuid()â”‚ â† PRIMARY KEY
â”‚ user_id         â”‚ UUID         â”‚ NOT NULL â”‚ -               â”‚ â† FOREIGN KEY â†’ auth.users(id)
â”‚ name            â”‚ TEXT         â”‚ NOT NULL â”‚ -               â”‚
â”‚ created_at      â”‚ TIMESTAMPTZ  â”‚ NOT NULL â”‚ NOW()           â”‚
â”‚ updated_at      â”‚ TIMESTAMPTZ  â”‚ NOT NULL â”‚ NOW()           â”‚ â† Auto-updated by trigger
â”‚ source_version  â”‚ TEXT         â”‚ NULLABLE â”‚ 'new_schema'    â”‚ â† Migration tracking
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Constraints Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CONSTRAINTS                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  PRIMARY KEY                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ children_pkey                           â”‚                 â”‚
â”‚  â”‚ ON (id)                                 â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                              â”‚
â”‚  FOREIGN KEY (NOT VALID âš¡)                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ fk_children_user_id                     â”‚                 â”‚
â”‚  â”‚ (user_id) â†’ auth.users(id)             â”‚                 â”‚
â”‚  â”‚ ON DELETE CASCADE                       â”‚                 â”‚
â”‚  â”‚ [NOT VALID - Fast creation]             â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚           â”‚                                                  â”‚
â”‚           â””â”€â”€â†’ Will validate in Phase 2                     â”‚
â”‚                                                              â”‚
â”‚  CHECK CONSTRAINTS (NOT VALID âš¡)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ check_children_name_length              â”‚                 â”‚
â”‚  â”‚ CHECK: length(name) BETWEEN 1 AND 100  â”‚                 â”‚
â”‚  â”‚ [NOT VALID]                             â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ check_children_source_version           â”‚                 â”‚
â”‚  â”‚ CHECK: source_version IN (...)         â”‚                 â”‚
â”‚  â”‚ [NOT VALID]                             â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                              â”‚
â”‚  UNIQUE CONSTRAINT (DEFERRABLE)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ unique_children_user_name               â”‚                 â”‚
â”‚  â”‚ UNIQUE (user_id, name)                 â”‚                 â”‚
â”‚  â”‚ DEFERRABLE INITIALLY DEFERRED           â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚           â”‚                                                  â”‚
â”‚           â””â”€â”€â†’ Allows bulk operations                       â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Index Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INDEX STRATEGY                            â”‚
â”‚              (All created CONCURRENTLY)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ idx_children_user_id                     â”‚  â† CRITICAL for RLS
   â”‚ B-tree on (user_id)                     â”‚
   â”‚ Use: WHERE user_id = $1                 â”‚
   â”‚ Impact: ğŸ”¥ğŸ”¥ğŸ”¥ (RLS policy lookups)     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                                 â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ idx_children_name    â”‚         â”‚ idx_children_user_nameâ”‚
   â”‚ B-tree on (name)     â”‚         â”‚ Composite (user_id,  â”‚
   â”‚ Use: Search/LIKE     â”‚         â”‚         name)        â”‚
   â”‚ Impact: ğŸ”¥ğŸ”¥         â”‚         â”‚ Use: Unique lookups  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ Impact: ğŸ”¥ğŸ”¥ğŸ”¥       â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                                 â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚idx_children_source_  â”‚         â”‚idx_children_created_atâ”‚
   â”‚       version        â”‚         â”‚ B-tree DESC           â”‚
   â”‚ Partial WHERE â‰  NULL â”‚         â”‚ Use: ORDER BY DESC   â”‚
   â”‚ Use: Migration stats â”‚         â”‚ Impact: ğŸ”¥           â”‚
   â”‚ Impact: ğŸ”¥           â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Trigger Mechanism

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TRIGGER FLOW                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  UPDATE children SET name = 'New Name' WHERE id = $1
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ BEFORE UPDATE Trigger              â”‚
  â”‚ trigger_children_updated_at        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Function:                          â”‚
  â”‚ update_children_updated_at()       â”‚
  â”‚                                    â”‚
  â”‚ BEGIN                              â”‚
  â”‚   NEW.updated_at = NOW();          â”‚
  â”‚   RETURN NEW;                      â”‚
  â”‚ END;                               â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
  Row updated with new updated_at timestamp
```

## RLS Policy Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ROW LEVEL SECURITY (RLS)                        â”‚
â”‚                                                              â”‚
â”‚  STATUS: ğŸ”´ DISABLED (Phase 0)                              â”‚
â”‚          ğŸŸ¢ WILL ENABLE (Phase 2)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  policy_children_    â”‚
â”‚      select          â”‚â”€â”€â”€â”€â”€â”€â”
â”‚                      â”‚      â”‚
â”‚ FOR SELECT           â”‚      â”‚
â”‚ USING (              â”‚      â”‚
â”‚   auth.uid() =       â”‚      â”‚
â”‚   user_id            â”‚      â”‚
â”‚ )                    â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  policy_children_    â”‚      â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      insert          â”‚â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–¶â”‚   auth.uid()        â”‚
â”‚                      â”‚      â”‚    â”‚                     â”‚
â”‚ FOR INSERT           â”‚      â”‚    â”‚ Supabase Auth JWT   â”‚
â”‚ WITH CHECK (         â”‚      â”‚    â”‚ Returns user UUID   â”‚
â”‚   auth.uid() =       â”‚      â”‚    â”‚                     â”‚
â”‚   user_id            â”‚      â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ )                    â”‚      â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚              â”‚
                              â”‚              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚              â”‚
â”‚  policy_children_    â”‚      â”‚              â”‚
â”‚      update          â”‚â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚                      â”‚      â”‚              â”‚
â”‚ FOR UPDATE           â”‚      â”‚              â”‚
â”‚ USING (              â”‚      â”‚              â”‚
â”‚   auth.uid() =       â”‚      â”‚    Compares with row's
â”‚   user_id            â”‚      â”‚    user_id to enforce
â”‚ )                    â”‚      â”‚    ownership
â”‚ WITH CHECK (         â”‚      â”‚
â”‚   auth.uid() =       â”‚      â”‚
â”‚   user_id            â”‚      â”‚
â”‚ )                    â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  policy_children_    â”‚      â”‚
â”‚      delete          â”‚â”€â”€â”€â”€â”€â”€â”˜
â”‚                      â”‚
â”‚ FOR DELETE           â”‚
â”‚ USING (              â”‚
â”‚   auth.uid() =       â”‚
â”‚   user_id            â”‚
â”‚ )                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PHASE 0 DATA FLOW                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CURRENT STATE (Old Schema):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   habit_tracker      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ id: 1            â”‚ â”‚
â”‚ â”‚ child_name: "ì•¨ë¦¬ìŠ¤"â”‚ â”‚
â”‚ â”‚ user_id: abc-123 â”‚ â”‚
â”‚ â”‚ week_start: ...  â”‚ â”‚
â”‚ â”‚ habits: [...]    â”‚ â”‚  â† Denormalized JSONB
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Phase 0: Backfill
         â”‚ (Not yet implemented)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   children           â”‚  â† NEW Shadow Schema
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ id: uuid-1       â”‚ â”‚
â”‚ â”‚ user_id: abc-123 â”‚ â”‚
â”‚ â”‚ name: "ì•¨ë¦¬ìŠ¤"    â”‚ â”‚
â”‚ â”‚ created_at: ...  â”‚ â”‚
â”‚ â”‚ source: migrationâ”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Phase 1: Dual Write
         â”‚ (Future)
         â–¼
    BOTH schemas kept in sync
```

## Migration Timeline

```
Phase 0 (Current)           Phase 1 (Next)          Phase 2 (Future)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CREATE TABLE â”‚            â”‚ Dual Write   â”‚        â”‚ Enable RLS   â”‚
â”‚ (Shadow)     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Old + New    â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Validate FK  â”‚
â”‚              â”‚            â”‚ Schemas      â”‚        â”‚ Full Switch  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                            â”‚                        â”‚
      â”‚ â€¢ Table created            â”‚ â€¢ Edge Functions       â”‚ â€¢ RLS ON
      â”‚ â€¢ NOT VALID                â”‚ â€¢ Triggers             â”‚ â€¢ Constraints
      â”‚ â€¢ Indexes CONCURRENT       â”‚ â€¢ Sync both schemas    â”‚   validated
      â”‚ â€¢ RLS policies             â”‚ â€¢ Monitor drift        â”‚ â€¢ Old schema
      â”‚   (inactive)               â”‚                        â”‚   deprecated
      â”‚ â€¢ Zero impact              â”‚                        â”‚
```

## Performance Characteristics

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PERFORMANCE METRICS                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Operation          â”‚ Index Used                â”‚ Complexity â”‚ Speed
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€
SELECT by user_id  â”‚ idx_children_user_id      â”‚ O(log n)   â”‚ ğŸš€ğŸš€ğŸš€
SELECT by name     â”‚ idx_children_name         â”‚ O(log n)   â”‚ ğŸš€ğŸš€
SELECT (user,name) â”‚ idx_children_user_name    â”‚ O(log n)   â”‚ ğŸš€ğŸš€ğŸš€
ORDER BY created   â”‚ idx_children_created_at   â”‚ O(log n)   â”‚ ğŸš€ğŸš€
INSERT             â”‚ All indexes updated       â”‚ O(log n)   â”‚ ğŸš€
UPDATE             â”‚ Trigger + index updates   â”‚ O(log n)   â”‚ ğŸš€
DELETE CASCADE     â”‚ FK cascade propagates     â”‚ O(n*m)     â”‚ ğŸš€

Index Build Time   â”‚ Method                    â”‚ Locks      â”‚ Safety
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€
All indexes        â”‚ CONCURRENTLY              â”‚ None       â”‚ 100%

Constraint Checks  â”‚ Status                    â”‚ Speed      â”‚ Risk
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€
Foreign Key        â”‚ NOT VALID                 â”‚ Instant    â”‚ 0%
Check constraints  â”‚ NOT VALID                 â”‚ Instant    â”‚ 0%
Unique constraint  â”‚ DEFERRABLE                â”‚ Fast       â”‚ 0%
```

## Storage Estimates

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   STORAGE ANALYSIS                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Per Row Size Estimate:
â”œâ”€ id (UUID):              16 bytes
â”œâ”€ user_id (UUID):         16 bytes
â”œâ”€ name (TEXT avg 10):     ~15 bytes (10 + overhead)
â”œâ”€ created_at (TIMESTAMPTZ): 8 bytes
â”œâ”€ updated_at (TIMESTAMPTZ): 8 bytes
â”œâ”€ source_version (TEXT):   ~15 bytes
â”œâ”€ Row overhead:           ~23 bytes (PostgreSQL)
â””â”€ Total per row:          ~101 bytes

For 10,000 children:
â”œâ”€ Table data:             ~1 MB
â”œâ”€ Indexes (5x):           ~2.5 MB
â”œâ”€ TOAST overhead:         ~0.1 MB
â””â”€ Total:                  ~3.6 MB

Scalability:
â”œâ”€ 100K children:          ~36 MB
â”œâ”€ 1M children:            ~360 MB
â””â”€ 10M children:           ~3.6 GB
```

## Validation Checklist

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              POST-MIGRATION VALIDATION                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â–¡ Table Structure
  â”œâ”€ âœ“ Table exists in public schema
  â”œâ”€ âœ“ 6 columns present
  â”œâ”€ âœ“ Correct data types
  â””â”€ âœ“ Correct nullability

â–¡ Constraints
  â”œâ”€ âœ“ Primary key on id
  â”œâ”€ âœ“ Foreign key to auth.users (NOT VALID)
  â”œâ”€ âœ“ Check: name length
  â”œâ”€ âœ“ Check: source_version enum
  â””â”€ âœ“ Unique: (user_id, name)

â–¡ Indexes
  â”œâ”€ âœ“ idx_children_user_id
  â”œâ”€ âœ“ idx_children_name
  â”œâ”€ âœ“ idx_children_user_name
  â”œâ”€ âœ“ idx_children_source_version (partial)
  â””â”€ âœ“ idx_children_created_at (DESC)

â–¡ Triggers
  â”œâ”€ âœ“ trigger_children_updated_at exists
  â””â”€ âœ“ Function update_children_updated_at() exists

â–¡ RLS
  â”œâ”€ âœ“ 4 policies created (SELECT, INSERT, UPDATE, DELETE)
  â”œâ”€ âœ“ Policies reference auth.uid()
  â””â”€ âœ“ RLS is DISABLED (Phase 0)

â–¡ Functional Tests
  â”œâ”€ âœ“ Can insert row with defaults
  â”œâ”€ âœ“ updated_at auto-updates
  â”œâ”€ âœ“ UUIDs auto-generate
  â””â”€ âœ“ Timestamps auto-set
```

---

**Legend:**
- ğŸ”´ Not active
- ğŸŸ¢ Active
- ğŸš€ Fast operation
- ğŸ”¥ High impact index
- âš¡ Performance optimization
- âœ“ Completed
- â–¡ To be checked

**File**: `supabase/migrations/CHILDREN_TABLE_DIAGRAM.md`
**Created**: 2025-10-12
**Author**: DB Architect
